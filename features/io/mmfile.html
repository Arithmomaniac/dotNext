<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
      <title>Direct Access to Memory-Mapped File | .NEXT </title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <meta name="title" content="Direct Access to Memory-Mapped File | .NEXT ">
      
      <link rel="icon" href="../../fav.ico">
      <link rel="stylesheet" href="../../public/docfx.min.css">
      <link rel="stylesheet" href="../../public/main.css">
      <meta name="docfx:navrel" content="../../toc.json">
      <meta name="docfx:tocrel" content="../toc.json">
      
      
      
      
      <meta name="docfx:docurl" content="https://github.com/dotnet/dotNext/blob/gh-pages/docs/features/io/mmfile.md/#L1">
      <meta name="loc:inThisArticle" content="In this article">
      <meta name="loc:searchResultsCount" content="{count} results for &quot;{query}&quot;">
      <meta name="loc:searchNoResults" content="No results for &quot;{query}&quot;">
      <meta name="loc:tocFilter" content="Filter by title">
      <meta name="loc:nextArticle" content="Next">
      <meta name="loc:prevArticle" content="Previous">
      <meta name="loc:themeLight" content="Light">
      <meta name="loc:themeDark" content="Dark">
      <meta name="loc:themeAuto" content="Auto">
      <meta name="loc:changeTheme" content="Change theme">
      <meta name="loc:copy" content="Copy">
      <meta name="loc:downloadPdf" content="Download PDF">
  </head>

  <script type="module" src="./../../public/docfx.min.js"></script>

  <script>
    const theme = localStorage.getItem('theme') || 'auto'
    document.documentElement.setAttribute('data-bs-theme', theme === 'auto' ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light') : theme)
  </script>


  <body class="tex2jax_ignore" data-layout="" data-yaml-mime="">
    <header class="bg-body border-bottom">
      <nav id="autocollapse" class="navbar navbar-expand-md" role="navigation">
        <div class="container-xxl flex-nowrap">
          <a class="navbar-brand" href="../../index.html">
            <img id="logo" class="svg" src="../../doc_logo.png" alt="">
            
          </a>
          <button class="btn btn-lg d-md-none border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navpanel" aria-controls="navpanel" aria-expanded="false" aria-label="Toggle navigation">
            <i class="bi bi-three-dots"></i>
          </button>
          <div class="collapse navbar-collapse" id="navpanel">
            <div id="navbar">
            </div>
          </div>
        </div>
      </nav>
    </header>

    <main class="container-xxl">
      <div class="toc-offcanvas">
        <div class="offcanvas-md offcanvas-start" tabindex="-1" id="tocOffcanvas" aria-labelledby="tocOffcanvasLabel">
          <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="tocOffcanvasLabel">Table of Contents</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" data-bs-target="#tocOffcanvas" aria-label="Close"></button>
          </div>
          <div class="offcanvas-body">
            <nav class="toc" id="toc"></nav>
          </div>
        </div>
      </div>

      <div class="content">
        <div class="actionbar">
          <button class="btn btn-lg border-0 d-md-none" style="margin-top: -.65em; margin-left: -.8em" type="button" data-bs-toggle="offcanvas" data-bs-target="#tocOffcanvas" aria-controls="tocOffcanvas" aria-expanded="false" aria-label="Show table of contents">
            <i class="bi bi-list"></i>
          </button>

          <nav id="breadcrumb"></nav>
        </div>

        <article data-uid="">
<h1 id="direct-access-to-memory-mapped-file">Direct Access to Memory-Mapped File</h1>

<p>.NET offers the two representations of the memory-mapped file:</p>
<ol>
<li><a href="https://docs.microsoft.com/en-us/dotnet/api/system.io.memorymappedfiles.memorymappedviewstream">MemoryMappedViewStream</a> for sequential access to the memory-mapped file</li>
<li><a href="https://docs.microsoft.com/en-us/dotnet/api/system.io.memorymappedfiles.memorymappedviewaccessor">MemoryMappedViewAccessor</a> for random access to the memory-mapped file</li>
</ol>
<p><a class="xref" href="../../api/DotNext.IO.MemoryMappedFiles.MemoryMappedFileExtensions.html">MemoryMappedFileExtensions</a> class provides additionals views of memory-mapped files.</p>
<h1 id="direct-access">Direct Access</h1>
<p><code>CreateDirectAccessor</code> extension method creates value of <a class="xref" href="../../api/DotNext.IO.MemoryMappedFiles.MemoryMappedDirectAccessor.html">MemoryMappedDirectAccessor</a> value type and gives the following benefits:</p>
<ul>
<li><code>Pointer</code> property provides direct access to the virtual memory</li>
<li><code>Bytes</code> property represents the content of the memory-mapped file as <a href="https://docs.microsoft.com/en-us/dotnet/api/system.span-1">Span&lt;byte&gt;</a></li>
</ul>
<p>The access is unsafe because it is organized through the pointer and bound checks are omitted. However, this approach allows to achive zero performance overhead in comparison with other views.</p>
<h1 id="compatibility-with-memorybyte">Compatibility with Memory&lt;byte&gt;</h1>
<p><code>CreateMemoryAccessor</code> extension method creates object of <a class="xref" href="../../api/DotNext.IO.MemoryMappedFiles.IMappedMemoryOwner.html">IMappedMemoryOwner</a> interface that provides access to mapped file memory via <a href="https://docs.microsoft.com/en-us/dotnet/api/system.memory-1">Memory&lt;T&gt;</a> data type. This is the main reason to use such representation of memory-mapped file. This approach has the main drawback: OS allocates pages of virtual memory for the specified segment of memory-mapped file so <code>Memory&lt;byte&gt;</code> can represent contiguous block of memory. If segment is too large then you can get <a href="https://docs.microsoft.com/en-us/dotnet/api/system.outofmemoryexception">OutOfMemoryException</a> exception. This problem can be avoided as described below.</p>
<h1 id="compatibility-with-readonlysequencebyte">Compatibility with ReadOnlySequence&lt;byte&gt;</h1>
<p>If file too large then attempt to map the whole file to memory is not possible. As a result, you cannot work with large files via <code>Memory&lt;byte&gt;</code> or <code>Span&lt;byte&gt;</code> data type. The only way is to represent memory-mapped file as non-contiguous segments of memory. .NET standard library offers <a href="https://docs.microsoft.com/en-us/dotnet/api/system.buffers.readonlysequence-1">ReadOnlySequence&lt;byte&gt;</a> data type to work with such structures. <a class="xref" href="../../api/DotNext.IO.MemoryMappedFiles.ReadOnlySequenceAccessor.html">ReadOnlySequenceAccessor</a> class can be used to obtain <code>ReadOnlySequence&lt;byte&gt;</code> over segments of memory-mapped file. The implementation provides the following features:</p>
<ul>
<li>Virtual memory is allocated only for the segment of file. The size of the segment can be defined as an argument of <code>ReadOnlySequenceAccessor</code> constructor.</li>
<li>Lazy switching between segments</li>
<li>Switching between segments is automatic and doesn't require involvement from API consumer</li>
</ul>
<p>Limitations are also presented:</p>
<ul>
<li>Instance of <a class="xref" href="../../api/DotNext.IO.MemoryMappedFiles.ReadOnlySequenceAccessor.html">ReadOnlySequenceAccessor</a> class is not thread-safe and must not be shared between threads without synchronization. Alternatively, you can obtain the source for each thread and use them separately. However, this approach will cause allocation of virtual memory for the segment in each thread.</li>
<li>Multiple instances of <code>ReadOnlySequence&lt;byte&gt;</code> obtained from single source share the same state and must not be shared across multiple threads. Moreover, usage of different sequences obtained from the same source can cause unwanted switches between segments of memory-mapped files.</li>
<li>The memory represents by the sequence is read-only. So you cannot use this accessor to modify contents of the file.</li>
</ul>

</article>

        <div class="contribution d-print-none">
          <a href="https://github.com/dotnet/dotNext/blob/gh-pages/docs/features/io/mmfile.md/#L1" class="edit-link">Edit this page</a>
        </div>

        <div class="next-article d-print-none border-top" id="nextArticle"></div>

      </div>

      <div class="affix">
        <nav id="affix"></nav>
      </div>
    </main>


    <footer class="border-top text-secondary">
      <div class="container-xxl">
        <div class="flex-fill">
          Supported by the <a href="https://dotnetfoundation.org">.NET Foundation</a>
        </div>
      </div>
    </footer>
  </body>
</html>
