<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
      <title>Metaprogramming | .NEXT </title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <meta name="title" content="Metaprogramming | .NEXT ">
      
      <link rel="icon" href="../../fav.ico">
      <link rel="stylesheet" href="../../public/docfx.min.css">
      <link rel="stylesheet" href="../../public/main.css">
      <meta name="docfx:navrel" content="../../toc.json">
      <meta name="docfx:tocrel" content="../toc.json">
      
      
      
      
      <meta name="docfx:docurl" content="https://github.com/dotnet/dotNext/blob/gh-pages/docs/features/metaprogramming/index.md/#L1">
      <meta name="loc:inThisArticle" content="In this article">
      <meta name="loc:searchResultsCount" content="{count} results for &quot;{query}&quot;">
      <meta name="loc:searchNoResults" content="No results for &quot;{query}&quot;">
      <meta name="loc:tocFilter" content="Filter by title">
      <meta name="loc:nextArticle" content="Next">
      <meta name="loc:prevArticle" content="Previous">
      <meta name="loc:themeLight" content="Light">
      <meta name="loc:themeDark" content="Dark">
      <meta name="loc:themeAuto" content="Auto">
      <meta name="loc:changeTheme" content="Change theme">
      <meta name="loc:copy" content="Copy">
      <meta name="loc:downloadPdf" content="Download PDF">
  </head>

  <script type="module" src="./../../public/docfx.min.js"></script>

  <script>
    const theme = localStorage.getItem('theme') || 'auto'
    document.documentElement.setAttribute('data-bs-theme', theme === 'auto' ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light') : theme)
  </script>


  <body class="tex2jax_ignore" data-layout="" data-yaml-mime="">
    <header class="bg-body border-bottom">
      <nav id="autocollapse" class="navbar navbar-expand-md" role="navigation">
        <div class="container-xxl flex-nowrap">
          <a class="navbar-brand" href="../../index.html">
            <img id="logo" class="svg" src="../../doc_logo.png" alt="">
            
          </a>
          <button class="btn btn-lg d-md-none border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navpanel" aria-controls="navpanel" aria-expanded="false" aria-label="Toggle navigation">
            <i class="bi bi-three-dots"></i>
          </button>
          <div class="collapse navbar-collapse" id="navpanel">
            <div id="navbar">
            </div>
          </div>
        </div>
      </nav>
    </header>

    <main class="container-xxl">
      <div class="toc-offcanvas">
        <div class="offcanvas-md offcanvas-start" tabindex="-1" id="tocOffcanvas" aria-labelledby="tocOffcanvasLabel">
          <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="tocOffcanvasLabel">Table of Contents</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" data-bs-target="#tocOffcanvas" aria-label="Close"></button>
          </div>
          <div class="offcanvas-body">
            <nav class="toc" id="toc"></nav>
          </div>
        </div>
      </div>

      <div class="content">
        <div class="actionbar">
          <button class="btn btn-lg border-0 d-md-none" style="margin-top: -.65em; margin-left: -.8em" type="button" data-bs-toggle="offcanvas" data-bs-target="#tocOffcanvas" aria-controls="tocOffcanvas" aria-expanded="false" aria-label="Show table of contents">
            <i class="bi bi-list"></i>
          </button>

          <nav id="breadcrumb"></nav>
        </div>

        <article data-uid="">
<h1 id="metaprogramming">Metaprogramming</h1>

<p>Metaprogramming API provided by .NEXT library allows to generate and execute code in runtime. Code generation object model is language agnostic so developer can use it from any .NET programming language. From design point of view, metaprogramming capabilities built on top of <a href="https://docs.microsoft.com/en-us/dotnet/api/system.linq.expressions">LINQ Expressions</a> without direct usage of IL generator. This increases portability of the library between different .NET implementations. All custom expressions introduced by Metaprogramming libary are reducible into predefined set of LINQ Expressions.</p>
<div class="WARNING">
<h5>Warning</h5>
<p>Xamarin.iOS supports only interpretation of Expression Trees without Just-in-Time Compilation. Since the iPhone's kernel prevents an application from generating code dynamically Mono on the iPhone does not support any form of dynamic code generation. Check out <a href="https://docs.microsoft.com/en-us/xamarin/ios/internals/limitations">this article</a> for more information. As a result, the code generated using .NEXT Metaprogramming library demonstrates significantly slower performance on iOS.</p>
</div>
<p>Metaprogramming library extends LINQ Expression with the following features:</p>
<ul>
<li><a href="https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/tokens/interpolated">String Interpolation</a></li>
<li><a href="https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/keywords/using-statement">using statement</a></li>
<li><a href="https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/keywords/lock-statement">lock statement</a></li>
<li>Loops
<ul>
<li><a href="https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/keywords/foreach-in">foreach loop</a></li>
<li><a href="https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/keywords/while">while loop</a></li>
<li><a href="https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/keywords/for">for loop</a></li>
</ul>
</li>
<li><a href="https://docs.microsoft.com/en-us/dotnet/visual-basic/language-reference/statements/with-end-with-statement">With..End statement</a></li>
<li>Full support of custom <a href="https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/keywords/async">async</a> lambda functions and <a href="https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/keywords/await">await</a> expressions</li>
<li><a href="https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/proposals/csharp-8.0/ranges">Ranges and Indicies</a></li>
<li>Pattern matching</li>
<li>Extension methods for easy construction of compound expressions and statements</li>
<li>Building expression trees using <strong>dynamic</strong> keyword in C#</li>
</ul>
<p>All these extensions are compatible with <a href="https://docs.microsoft.com/en-us/dotnet/api/system.linq.expressions.expression">Expression</a> class.</p>
<p>Additionally, .NEXT Metaprogramming library replaces limit of <a href="https://docs.microsoft.com/en-us/dotnet/csharp/programming-guide/concepts/expression-trees/">C# Expression Trees</a> where only single-line lambda expression is allowed.</p>
<div class="IMPORTANT">
<h5>Important</h5>
<p>Despite of rich set of Metaprogramming API, a few limits still exist. These restrictions dictated by internal design of LINQ Expression. The first, overloaded operators with <a href="https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/keywords/in-parameter-modifier">in parameter modifier</a> cannot be resolved. The second, <a href="https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/keywords/ref#reference-return-values">ref return</a> and <a href="https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/keywords/ref#ref-locals">ref locals</a> are not supported.</p>
</div>
<h1 id="concept">Concept</h1>
<p>The code construction based on the following concepts:</p>
<ul>
<li><a href="dynamic.html">Dynamic Construction of Expressions</a></li>
<li><a class="xref" href="../../api/DotNext.Metaprogramming.CodeGenerator.html">Code Generator</a> provides methods for adding statement such as method calls, assignment, loops, if-then-else statement etc.</li>
<li><a class="xref" href="../../api/DotNext.Linq.Expressions.ExpressionBuilder.html">Expression Builder</a> provides extension methods for constructing expressions</li>
</ul>
<p><a href="https://docs.microsoft.com/en-us/dotnet/api/system.linq.expressions">Code expressions</a> from .NET library heavily extended with additional expression types:</p>
<ul>
<li><a class="xref" href="../../api/DotNext.Linq.Expressions.UsingExpression.html">using Expression</a> represents <code>using</code> statement from C#</li>
<li><a class="xref" href="../../api/DotNext.Linq.Expressions.LockExpression.html">lock Expression</a> represents <code>lock</code> statement from C#</li>
<li><a class="xref" href="../../api/DotNext.Linq.Expressions.AwaitExpression.html">await Expression</a> represents <code>await</code> operator from C#</li>
<li><a class="xref" href="../../api/DotNext.Linq.Expressions.InterpolationExpression.html">String Interpolation Expression</a> represents interpolated string</li>
<li><a class="xref" href="../../api/DotNext.Linq.Expressions.ForEachExpression.html">for-in Expression</a> represents <code>foreach</code> loop from C#</li>
<li><a class="xref" href="../../api/DotNext.Linq.Expressions.WhileExpression.html">while Expression</a> represents <code>while</code> and <code>do-while</code> loops from C#</li>
<li><a class="xref" href="../../api/DotNext.Linq.Expressions.ForExpression.html">for Expression</a> represents <code>for</code> loop from C#</li>
<li><a class="xref" href="../../api/DotNext.Linq.Expressions.CollectionAccessExpression.html">Element Access Expression</a> represents <a href="https://docs.microsoft.com/en-us/dotnet/api/system.index">index</a>-based access to individual elements of the collection or string</li>
<li><a class="xref" href="../../api/DotNext.Linq.Expressions.SliceExpression.html">Slice Expression</a> represents <a href="https://docs.microsoft.com/en-us/dotnet/api/system.range">range</a> of elements in arbitrary collection or string</li>
</ul>
<p>The lexical scope is enclosed by multi-line lambda function. The body of such function contains the code for generation of expressions and statements.</p>
<pre><code class="lang-csharp">using DotNext.Linq.Expressions;
using System;
using System.Linq.Expressions;
using static DotNext.Metaprogramming.CodeGenerator;

Func&lt;long, long&gt; fact = Lambda&lt;Func&lt;long, long&gt;&gt;(fun =&gt; 
{
    var arg = fun[0];    //declares access to lambda parameter
    //if-then-else expression
    If((Expression)(arg.AsDynamic() &gt; 1L))
        .Then(arg.AsDynamic() * fun.Invoke(arg.AsDynamic() - 1L))  //recursive invocation of the current lambda function
        .Else(arg)  //else branch
        .OfType&lt;long&gt;()
    .End();
    //declare local variable of type long
    var local = DeclareVariable&lt;long&gt;(&quot;local&quot;);
    //assignment
    Assign(local, -arg.AsDynamic());  //equivalent is the assignment statement local = -arg
    //try-catch
    Try(() =&gt; 
    {
        Return(10.Const());    //return from lambda function
    })
    .Finally(() =&gt; //finally block
    {  
        //method call Console.WriteLine(local);
        CallStatic(typeof(Console), nameof(Console.WriteLine), local);
    })
    .End(); //end of try block
}).Compile();
</code></pre>
<p>Statement construction methods from <code>CodeGenerator</code> mimic syntax of C# programming language that improves maintainability of the code.</p>

</article>

        <div class="contribution d-print-none">
          <a href="https://github.com/dotnet/dotNext/blob/gh-pages/docs/features/metaprogramming/index.md/#L1" class="edit-link">Edit this page</a>
        </div>

        <div class="next-article d-print-none border-top" id="nextArticle"></div>

      </div>

      <div class="affix">
        <nav id="affix"></nav>
      </div>
    </main>


    <footer class="border-top text-secondary">
      <div class="container-xxl">
        <div class="flex-fill">
          Supported by the <a href="https://dotnetfoundation.org">.NET Foundation</a>
        </div>
      </div>
    </footer>
  </body>
</html>
