<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
      <title>Application Maintenance Interface | .NEXT </title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <meta name="title" content="Application Maintenance Interface | .NEXT ">
      
      <link rel="icon" href="../../fav.ico">
      <link rel="stylesheet" href="../../public/docfx.min.css">
      <link rel="stylesheet" href="../../public/main.css">
      <meta name="docfx:navrel" content="../../toc.json">
      <meta name="docfx:tocrel" content="../toc.json">
      
      
      
      
      <meta name="docfx:docurl" content="https://github.com/dotnet/dotNext/blob/gh-pages/docs/features/ami/index.md/#L1">
      <meta name="loc:inThisArticle" content="In this article">
      <meta name="loc:searchResultsCount" content="{count} results for &quot;{query}&quot;">
      <meta name="loc:searchNoResults" content="No results for &quot;{query}&quot;">
      <meta name="loc:tocFilter" content="Filter by title">
      <meta name="loc:nextArticle" content="Next">
      <meta name="loc:prevArticle" content="Previous">
      <meta name="loc:themeLight" content="Light">
      <meta name="loc:themeDark" content="Dark">
      <meta name="loc:themeAuto" content="Auto">
      <meta name="loc:changeTheme" content="Change theme">
      <meta name="loc:copy" content="Copy">
      <meta name="loc:downloadPdf" content="Download PDF">
  </head>

  <script type="module" src="./../../public/docfx.min.js"></script>

  <script>
    const theme = localStorage.getItem('theme') || 'auto'
    document.documentElement.setAttribute('data-bs-theme', theme === 'auto' ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light') : theme)
  </script>


  <body class="tex2jax_ignore" data-layout="" data-yaml-mime="">
    <header class="bg-body border-bottom">
      <nav id="autocollapse" class="navbar navbar-expand-md" role="navigation">
        <div class="container-xxl flex-nowrap">
          <a class="navbar-brand" href="../../index.html">
            <img id="logo" class="svg" src="../../doc_logo.png" alt="">
            
          </a>
          <button class="btn btn-lg d-md-none border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navpanel" aria-controls="navpanel" aria-expanded="false" aria-label="Toggle navigation">
            <i class="bi bi-three-dots"></i>
          </button>
          <div class="collapse navbar-collapse" id="navpanel">
            <div id="navbar">
            </div>
          </div>
        </div>
      </nav>
    </header>

    <main class="container-xxl">
      <div class="toc-offcanvas">
        <div class="offcanvas-md offcanvas-start" tabindex="-1" id="tocOffcanvas" aria-labelledby="tocOffcanvasLabel">
          <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="tocOffcanvasLabel">Table of Contents</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" data-bs-target="#tocOffcanvas" aria-label="Close"></button>
          </div>
          <div class="offcanvas-body">
            <nav class="toc" id="toc"></nav>
          </div>
        </div>
      </div>

      <div class="content">
        <div class="actionbar">
          <button class="btn btn-lg border-0 d-md-none" style="margin-top: -.65em; margin-left: -.8em" type="button" data-bs-toggle="offcanvas" data-bs-target="#tocOffcanvas" aria-controls="tocOffcanvas" aria-expanded="false" aria-label="Show table of contents">
            <i class="bi bi-list"></i>
          </button>

          <nav id="breadcrumb"></nav>
        </div>

        <article data-uid="">
<h1 id="application-maintenance-interface">Application Maintenance Interface</h1>

<p>.NET ecosystem provides a rich set of tools for collecting runtime metrics and diagnostics information. However, this is one-way communication with the application. What if administrator wants to trigger Garbage Collector or clear cache? <strong>Application Maintenance Interface</strong> (AMI) provides a way to send maintenance commands to .NET application directly.</p>
<p>AMI is a sort of Inter-Process Communication specially designed to have first-class support by command-line shells such as Bash. The implementation is constructed on top of open technologies:</p>
<ul>
<li>IPC transport layer is based on Unix Domain Sockets</li>
<li>Input is just a plain text</li>
<li>The format of the input follows convention of POSIX or Windows command-line tools</li>
</ul>
<p>In other words, AMI is very similar to Telnet or SSH.</p>
<div class="NOTE">
<h5>Note</h5>
<p>AMI is secure, because there is no way to establish connection to the application remotely. Unix Domain Socket is a form of IPC without support of connection through the network. However, administrator can still use SSH to connect to the host or container and then execute command via command-line shell using, for instance, <em>netcat</em>.</p>
</div>
<p>AMI can be seen as alternative to <a href="https://docs.oracle.com/javase/8/docs/technotes/guides/jmx/index.html">Java Management Extensions</a> but built natively for .NET and based on open technologies. The following table describes the difference between these technologies:</p>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>JMX</th>
<th>AMI</th>
</tr>
</thead>
<tbody>
<tr>
<td>Data format</td>
<td>Binary (Java serialization)</td>
<td>Plain text</td>
</tr>
<tr>
<td>Direct remote access</td>
<td>Yes</td>
<td>No</td>
</tr>
<tr>
<td>Requires special client app</td>
<td>Yes (for instance, VisualVM)</td>
<td>No</td>
</tr>
<tr>
<td>Built-in support of Kubernetes probes</td>
<td>No</td>
<td>Yes</td>
</tr>
</tbody>
</table>
<p>AMI provides the following maintenace commands out-of-the-box:</p>
<ul>
<li><code>gc</code> - forces Garbage Collection or sets compaction mode for LOH</li>
<li><code>interactive-mode</code> - enters interactive mode. This mode is suitable for administrators</li>
<li><code>exit</code> - leaves interactive mode</li>
<li><code>probe</code> - execute application probe. See <a href="probes.html">here</a> for more information</li>
</ul>
<p>At the application startup, AMI infrastructure creates interaction point represented by pseudo file of Unix Domain Socket type. This path can be used by tools like <code>nc</code> for connection from the terminal session:</p>
<pre><code class="lang-sh">nc -U /path/to/unix/domain/socket
</code></pre>
<p>For instance, you can force Garbage Collection directly from the command-line shell:</p>
<pre><code class="lang-sh">echo gc collect 2 | nc -U /path/to/unix/domain/socket
</code></pre>
<p>If you want to send the command programmatically then you need to insert line termination sequence (<code>\n</code> on Unix, or <code>\n\r</code> on Windows) or null character (<code>\0</code>) in the end of each command.</p>
<p>Some of the commands may produce output in the form of plain text.</p>
<p>In interactive mode, administrator can use standard flags <code>-h</code> or <code>--help</code> to get help for the commands or subcommands.</p>
<h1 id="ami-hosting">AMI Hosting</h1>
<p>AMI is supported for the application with or without Dependency Injection support. For simplicity, all code examples implies DI enabled.</p>
<p>The following code snippet demonstrates bare minimum to enable AMI for the application:</p>
<pre><code class="lang-csharp">using DotNext.Maintenance.CommandLine;

await new HostBuilder()
    .ConfigureServices(static services =&gt;
    {
        services
            .RegisterDefaultMaintenanceCommands()
            .UseApplicationMaintenanceInterface(&quot;/path/to/unix/domain/socket&quot;);
    })
    .Build()
    .RunAsync();
</code></pre>
<p><code>RegisterDefaultMaintenanceCommands</code> extension method registers default set of maintenance commands (<code>gc</code>, <code>interactive-mode</code>, <code>exit</code>). <code>UseApplicationMaintenanceInterface</code> registers a host that listens for the commands to be received through Unix Domain Socket at the specificed location. Note that pseudo file at that path <strong>should not</strong> exist before application startup. The file will be created by the host automatically. However, if file exists, the host throws an exception.</p>
<h1 id="custom-commands">Custom Commands</h1>
<p>Command parsing is implemented on top of <a href="https://docs.microsoft.com/en-us/dotnet/standard/commandline/">System.CommandLine</a> open-source library. <a class="xref" href="../../api/DotNext.Maintenance.CommandLine.ApplicationMaintenanceCommand.html">ApplicationMaintenanceCommand</a> class represents maintenance command that can be registered in DI:</p>
<pre><code class="lang-csharp">using System.Buffers;
using System.CommandLine;
using System.CommandLine.Parsing;
using DotNext.Maintenance.CommandLine;
using DotNext.Maintenance.CommandLine.Binding;
using Microsoft.Extensions.Hosting;

await new HostBuilder()
    .ConfigureServices(static services =&gt;
    {
        services
            .UseApplicationMaintenanceInterface(&quot;/path/to/unix/domain/socket&quot;)
            .RegisterMaintenanceCommand(&quot;add&quot;, ConfigureAddCommand);
    })
    .Build()
    .RunAsync();

static void ConfigureAddCommand(ApplicationMaintenanceCommand command)
{
    command.Description = &quot;Adds two integers&quot;;
    var argX = new Argument&lt;int&gt;(&quot;x&quot;, parse: ParseInteger, description: &quot;The first operand&quot;)
    {
        Arity = ArgumentArity.ExactlyOne
    };
    var argY = new Argument&lt;int&gt;(&quot;y&quot;, parse: ParseInteger, description: &quot;The second operand&quot;)
    {
        Arity = ArgumentArity.ExactlyOne,
    };

    command.AddArgument(argX);
    command.AddArgument(argY);
    command.SetHandler(static (x, y, console) =&gt;
    {
        console.Out.Write((x + y).ToString());
        console.Out.Write(Environment.NewLine);
    },
    argX,
    argY,
    DefaultBindings.Console);
}
</code></pre>
<p>Registered custom commands will be automatically discovered by AMI host. <a class="xref" href="../../api/DotNext.Maintenance.CommandLine.Binding.DefaultBindings.html">DefaultBindings</a> provides extra bindings available for the commands when executing by AMI host.</p>
<h1 id="security">Security</h1>
<p>AMI is based on Unix Domain Sockets. It means that there is no way to have a direct connection to the application remotely. Potential attacker must have a direct access to the container or operating system to interact with the app via AMI. In most cases, it should be enough to protect the interface. However, administrator can use the following approaches to improve security:</p>
<ul>
<li>Configure access rights for the pseudo file at file system level</li>
<li>Use authentication and authorization at AMI level</li>
</ul>
<p>Read more <a href="auth.html">here</a> about authentication and authorization in AMI.</p>
<h1 id="directives">Directives</h1>
<p>AMI supports special directives aimed to control output:</p>
<ul>
<li><code>[prnec]</code> - prints exit code of the command in square brackets at the beginning of the output</li>
<li><code>[supout]</code> - suppresses command output</li>
<li><code>[superr]</code> - suppresses command error output</li>
</ul>
<p>The following example demonstrates how to add exit code to the probe output:</p>
<pre><code class="lang-sh">[prnec] probe liveness 00:00:01
</code></pre>
<h1 id="example">Example</h1>
<p>You can find a simple application with AMI enabled <a href="https://github.com/dotnet/dotNext/tree/master/src/examples/CommandLineAMI">here</a>. All you need is to run it with <code>dotnet run</code> command and follow instructions printed by the app.</p>

</article>

        <div class="contribution d-print-none">
          <a href="https://github.com/dotnet/dotNext/blob/gh-pages/docs/features/ami/index.md/#L1" class="edit-link">Edit this page</a>
        </div>

        <div class="next-article d-print-none border-top" id="nextArticle"></div>

      </div>

      <div class="affix">
        <nav id="affix"></nav>
      </div>
    </main>


    <footer class="border-top text-secondary">
      <div class="container-xxl">
        <div class="flex-fill">
          Supported by the <a href="https://dotnetfoundation.org">.NET Foundation</a>
        </div>
      </div>
    </footer>
  </body>
</html>
